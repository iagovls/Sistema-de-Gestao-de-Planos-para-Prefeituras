#!/bin/bash
sudo yum update -y && sudo yum install -y docker git

# Instalar Docker Compose
sudo mkdir -p /usr/local/lib/docker/cli-plugins
sudo curl -L https://github.com/docker/compose/releases/download/v2.39.2/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

# Iniciar Docker
sudo systemctl start docker && sudo systemctl enable docker
sudo usermod -a -G docker ec2-user

# Clonar o repositório
cd /home/ec2-user

GITHUB_TOKEN=$(sudo aws ssm get-parameter \
  --name "/github/pat" \
  --with-decryption \
  --query "Parameter.Value" \
  --output text \
  --region us-east-1)

git clone https://iagovls:${GITHUB_TOKEN}@github.com/iagovls/Sistema-de-Gestao-de-Planos-para-Prefeituras.git

cd Sistema-de-Gestao-de-Planos-para-Prefeituras

sudo dnf install mariadb105 -y


# Crie o arquivo SQL
echo "CREATE DATABASE IF NOT EXISTS propostasDB;" > /tmp/setup.sql

# Execute o comando e passe a senha com -p seguido da senha (sem espaço)
mysql -h database-1.ck9ow20ccz8f.us-east-1.rds.amazonaws.com \
  -P 3306 \
  -u admin \
  -p'WQpB6apqNwsb2LcY0ys5' \
 < /tmp/setup.sql

sudo aws s3 sync s3://ssl-ec2-monitoramento-cmdca/letsencrypt/ /etc/letsencrypt/ || true

sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Opcional: Remova o arquivo temporário por segurança
rm /tmp/setup.sql





# Build do backend localmente (se necessário)
# cd www
# chmod +x mvnw
# ./mvnw clean package -DskipTests
# cd ..

# Iniciar os serviços
cd Sistema-de-Gestao-de-Planos-para-Prefeituras
sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d



# Configurar logs
echo "Deploy completed at $(date)" >> /var/log/deploy.log