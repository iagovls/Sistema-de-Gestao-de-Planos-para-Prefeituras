#!/bin/bash
sudo yum update -y && sudo yum install -y docker git

# Instalar Docker Compose
sudo mkdir -p /usr/local/lib/docker/cli-plugins
sudo curl -L https://github.com/docker/compose/releases/download/v2.39.2/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

# Iniciar Docker
sudo systemctl start docker && sudo systemctl enable docker
sudo usermod -a -G docker ec2-user

# Clonar o repositório
cd /home/ec2-user

GITHUB_TOKEN=$(sudo aws ssm get-parameter \
  --name "/github/pat" \
  --with-decryption \
  --query "Parameter.Value" \
  --output text \
  --region us-east-1)

git clone https://iagovls:${GITHUB_TOKEN}@github.com/iagovls/Sistema-de-Gestao-de-Planos-para-Prefeituras.git

cd Sistema-de-Gestao-de-Planos-para-Prefeituras

# sudo dnf install mariadb105 -y
# WQpB6apqNwsb2LcY0ys5
# create database propostasDB





# Build do backend localmente (se necessário)
# cd www
# chmod +x mvnw
# ./mvnw clean package -DskipTests
# cd ..

# Iniciar os serviços
sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Configurar logs
echo "Deploy completed at $(date)" >> /var/log/deploy.log