name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build:

    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      GITHUB_TOKEN: ${{ secrets.GB_TOKEN }}

    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@main
      with:
        aws-region: us-east-1
        role-to-assume: arn:aws:iam::622840651405:role/GitHubActionsDeployRole    

    - name: Deploy on EC2 (git pull + docker compose)
      uses: appleboy/ssh-action@v1
      with:
        host: "ec2-34-195-163-35.compute-1.amazonaws.com"
        username: ec2-user
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          cd /home/ec2-user/Sistema-de-Gestao-de-Planos-para-Prefeituras
          git pull origin main
          cat > .env.prod << 'EOF'
          API_SECURITY_TOKEN_SECRET=${{ secrets.API_SECURITY_TOKEN_SECRET }}
          SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
          SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
          SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          SPRING_PROFILES_ACTIVE=prod
          EOF
          docker compose pull
          sudo docker compose down && sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d


